# AI CODER RULES

> **IMPORTANT:** `CLAUDE.md` and `GEMINI.md` are symlinks to this file. Do not delete or rename `AI_CODER_RULES.md` - edit it in place to update rules for all AI tools.

**For full documentation, see [README.md](README.md).** This file contains quick-reference rules for AI coders.

## Project Overview

Open water swimming conditions app (shallweswim.today). Aggregates tide, current, and temperature data from NOAA CO-OPS, NOAA NDBC, and USGS NWIS APIs for multiple locations.

## Essential Commands

```bash
uv run pytest -v -k "not integration"   # Unit tests (default)
uv run ruff check .                      # Linting
uv run ruff format --check .             # Formatting check
uv run basedpyright                      # Type checking
uv run pre-commit run --all-files        # All quality checks
uv run python -m shallweswim.main --port=12345  # Run locally
```

## Critical Rules

1. **Use uv for everything** - Never use pip, poetry, or bare python. Always `uv run <command>`.
2. **Run commands from repo root** - Don't cd into subdirectories.
3. **Run pre-commit after major changes** - Catches formatting, linting, and type errors.
4. **Don't run integration tests** unless explicitly requested - They hit live external APIs.
5. **Follow ARCHITECTURE.md strictly** - See [ARCHITECTURE.md](ARCHITECTURE.md) for architecture and coding standards.
6. **Never modify station configurations** - Do not change NOAA/USGS station IDs or data sources without explicit user approval. Configuration changes are out of scope.
7. **No AI attribution in commits** - Do not include "Co-Authored-By", "Generated by", or similar AI tool author mentions in commit messages or code comments.
8. **Never git commit without explicit user approval** - Always wait for the user to approve before running git commit.
9. **Keep documentation in sync** - Update README.md, ARCHITECTURE.md, and docstrings when implementing features, refactoring, or changing behavior. Commits should be atomic: include both code and documentation changes together.

## Architecture Quick Reference

```text
User Request:  API Handler → LocationDataManager → queries → Feed (cached data)
Background:    updater → Feed → ApiClient → External Service → Update Cache
```

```text
shallweswim/
├── main.py           # App entry, web UI routes
├── api/              # JSON API routes
│   └── routes.py     # Route handlers (delegates to core/)
├── config/           # Configuration
│   └── locations.py  # Location configs and station IDs
├── core/             # Business logic
│   ├── manager.py    # LocationDataManager coordinates feeds
│   ├── queries.py    # Query functions (temp, tide, current info)
│   ├── updater.py    # Background update helpers
│   └── feeds.py      # Feed classes with caching/expiration
├── clients/          # Pure API clients (coops, ndbc, nwis)
└── plotting.py       # Chart generation (process pool)
```

## Error Handling Philosophy

- **Internal bugs (our code)**: Fail fast, log ERROR, let it crash - developers need to notice and fix
- **External API failures (NOAA, USGS)**: Log ERROR for visibility, but continue/retry - transient issues self-heal
- Background update loop: Catch external errors, log them, continue loop to retry on next interval
- Never silently swallow errors - always log at appropriate level (WARNING for expected, ERROR for unexpected)

## Before Implementing

- Check existing patterns in similar code before writing new code
- New locations: config/locations.py → core/manager.py → api/routes.py → main.py → tests
- CPU-bound work (plotting): Must use process pool, not async
